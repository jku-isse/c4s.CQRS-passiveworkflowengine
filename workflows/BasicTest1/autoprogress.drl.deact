package processdefinition;

import org.axonframework.commandhandling.gateway.CommandGateway;

import java.util.stream.Collectors;
import java.util.Optional
import java.time.Instant
import java.util.concurrent.TimeUnit
import java.util.Collections;
import java.util.List
import java.util.ArrayList
import java.util.Map
import java.util.Set
import java.util.HashMap
import java.util.LinkedHashMap
import java.util.Iterator;
import java.net.URL;

import passiveprocessengine.definition.ArtifactTypes
import passiveprocessengine.instance.*
import passiveprocessengine.definition.*
import passiveprocessengine.definition.TaskLifecycle.State;

import artifactapi.ResourceLink
import artifactapi.IArtifact
import artifactapi.IArtifactRegistry
import artifactapi.ArtifactIdentifier
import artifactapi.IArtifactRegistry

import impactassessment.artifactconnector.demo.*
import c4s.impactassessment.tools.*

import impactassessment.kiesession.KieSessionUtils
import impactassessment.api.Commands.*
import impactassessment.api.Events.*
import org.axonframework.commandhandling.gateway.CommandGateway


global CommandGateway commandGateway;
global IArtifactRegistry artifactRegistry;

/**/
rule "activatedClosedTaskPrematurely"
salience 1000
no-loop
	when
		$wfi : WorkflowInstance()
		not UpdateArtifactsCmd ( getId().equals( $wfi.getId()) )
		not WorkflowTask(  getType().getId().equals("Closed") )
	then
		// here we access the singleton collection of artifacts that also the DemoService is using
		Basic1Artifacts.req1.getPropertyMap().put(DemoRequirement.propKeys.assessment.toString(), DemoRequirement.assessmentValues.inpreparation.toString());		
		UpdateArtifactsCmd cmd = new UpdateArtifactsCmd($wfi.getId(), List.of(Basic1Artifacts.req1));
		commandGateway.send(cmd);
		insert (cmd);
end

rule "completeOpenTaskRegular"
salience 900
no-loop
	when
		$wft : WorkflowTask (   getType().getId().equals("Open") &&
								(getActualLifecycleState().equals(TaskLifecycle.State.ACTIVE)) )
		eval ( !Basic1Artifacts.req1.getProperty("status").equalsIgnoreCase("inprogress") )								
	then
		Basic1Artifacts.req1.getPropertyMap().put(DemoRequirement.propKeys.status.toString(), DemoRequirement.statusValues.inprogress.toString());
		commandGateway.send(new UpdateArtifactsCmd($wft.getWorkflow().getId(), List.of(Basic1Artifacts.req1)) );		
end

rule "completeClosedTaskRegular"
salience 800
no-loop
	when
		$wft : WorkflowTask (   getType().getId().equals("Closed") &&
								(getActualLifecycleState().equals(TaskLifecycle.State.ACTIVE)) )
	then
		Basic1Artifacts.req2.getPropertyMap().put(DemoRequirement.propKeys.status.toString(), DemoRequirement.statusValues.completed.toString());
		Basic1Artifacts.req4.getPropertyMap().put(DemoRequirement.propKeys.status.toString(), DemoRequirement.statusValues.completed.toString());
		commandGateway.send(new UpdateArtifactsCmd($wft.getWorkflow().getId(), List.of(Basic1Artifacts.req2, Basic1Artifacts.req4)) );		
		
end
/**/